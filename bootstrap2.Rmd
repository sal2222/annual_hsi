---
title: "bootstrap"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/slewa/Projects/heat_stress")


library(tidyverse)
library(readxl)
library(knitr)
library(kableExtra)
library(purrr)
library(furrr)
library(boot)
library(lme4)
library(ICC) 
library(dotwhisker)
library(broom)
library(car)
library(reshape2)
library(sjPlot)
library(readxl)
library(broom.mixed)
library(bbmle)
library(glmmTMB)
library(performance)
library(MASS)
library(mgcv)
library(gridExtra)
library(tableone)
library(corrr)
library(psych)
library(zoo)
library(patchwork) # install_github("thomasp85/patchwork")
library(vcd)
library(table1)

```

Annual models from DMED data and annual indices of heat and humidity from NLDAS-2

- load and prepare data
- create outcome-specific datasets
- negative binomial models (with and w/out year term), non-bootstrap
- 2-year block bootstraps (select indices, 10k resamples, `basic` and `bca` CIs)
- 2-year block bootstraps (all 90 indices, 2k resamples)
- 3-year block bootstraps (select indices, 10k resamples)
- standard bootstrap (select indices, 10k resamples)

## Load and prepare data
```{r load_datasets, message = FALSE}

joined_hsi <-
  read_rds("data/joined_hsi.rds")

canopy_stats <-
  read_rds("data/canopy_stats_na_reclassified.rds") %>% 
  mutate(installation_lower = janitor::make_clean_names(installation))

# Remove Fort Irwin/NTC due to low counts/rates and transient training
# Remove initial year of health outcomes (1990 for Hospitilizations, 1997 for Ambulatory)

hsi_data <-
  joined_hsi %>% 
    left_join(canopy_stats %>% 
                dplyr::select(installation_lower, mean_canopy),
              by = c("installation" = "installation_lower")) %>% 
    filter(!installation %in% "ntc_and_fort_irwin",
           !(type %in% "Hospitalizations" & year %in% 1990),
           !(type %in% "Ambulatory Data" & year %in% 1997)) %>% 
    mutate(installation = factor(installation, ordered = FALSE),
         index = factor(index, ordered = FALSE),
         type = factor(type, ordered = FALSE),
         bct = factor(bct), 
         installation = relevel(installation, ref = "fort_bliss"))

levels(hsi_data$installation)

summary(hsi_data)


hsi_select <- hsi_data %>% 
  filter(index %in% c("days_tmp_gt85pct_may_sep",              #relative, heat season
                      "days_wbgt_gt85pct_may_sep",             #relative, heat season
                      "days_heat_index_gt85pct_may_sep",       #relative, heat season
                      "tmp_mean_may_sep",                      #absolute, heat season
                      "heat_index_mean_may_sep",               #absolute, heat season
                      "wbgt_f_mean_may_sep",                   #absolute, heat season
                      "tmp_f_mean",                            #absolute, year-round
                      "heat_index_mean",                       #absolute, year-round
                      "wbgt_f_mean"))                          #absolute, year-round


hsi_select

```

### Outcome-specific datasets

```{r outcome_filtered}

ambulatory_data <-
  hsi_select %>%
      filter(type %in% "Ambulatory Data") %>% 
      dplyr::select(index, installation, year, count, value, population) %>% 
      mutate(installation = as.character(installation))


hospitalization_data <-
  hsi_select %>%
      filter(type %in% "Hospitalizations") %>% 
      dplyr::select(index, installation, year, count, value, population) %>% 
      mutate(installation = as.character(installation))


rme_data <-
  hsi_select %>%
      filter(type %in% "Reportable Events") %>% 
      dplyr::select(index, installation, year, count, value, population) %>% 
      mutate(installation = as.character(installation))


ambulatory_data_full <-
  hsi_data %>%
      filter(type %in% "Ambulatory Data") %>% 
      dplyr::select(index, installation, year, count, value, population) %>% 
      mutate(installation = as.character(installation))


hospitalization_data_full <-
  hsi_data %>%
      filter(type %in% "Hospitalizations") %>% 
      dplyr::select(index, installation, year, count, value, population) %>% 
      mutate(installation = as.character(installation))


rme_data_full <-
  hsi_data %>%
      filter(type %in% "Reportable Events") %>% 
      dplyr::select(index, installation, year, count, value, population) %>% 
      mutate(installation = as.character(installation))



```



Note: "days_tmp_gt95pct_may_sep", for each calendar day, compares mean daily temperature with 95th %-ile of 30-year (1990-2019) climatology for that day




## Base models (with and without year)

```{r}

nb_fun = function(df) {
  df %>%
    MASS::glm.nb(count ~ value + installation + offset(log(population)), data = .)
}

nb_year_fun = function(df) {
  df %>%
    MASS::glm.nb(count ~ value + installation + year + offset(log(population)), data = .)
}


amb_nb <-
  ambulatory_data %>% 
    nest(data = installation:population) %>% 
    mutate(nb_mod = map(data, nb_fun),
           nb_tidy =   map(nb_mod, ~ broom::tidy(., conf.int = TRUE)),
           nb_year_mod = map(data, nb_year_fun),
           nb_year_tidy = map(nb_year_mod, ~ broom::tidy(., conf.int = TRUE)))


hosp_nb <-
  hospitalization_data %>% 
    nest(data = installation:population) %>% 
    mutate(nb_mod = map(data, nb_fun),
           nb_tidy =   map(nb_mod, ~ broom::tidy(., conf.int = TRUE)),
           nb_year_mod = map(data, nb_year_fun),
           nb_year_tidy = map(nb_year_mod, ~ broom::tidy(., conf.int = TRUE)))

hosp_nb 


rme_nb <-
  rme_data %>% 
    nest(data = installation:population) %>% 
    mutate(nb_mod = map(data, nb_fun),
           nb_tidy =   map(nb_mod, ~ broom::tidy(., conf.int = TRUE)),
           nb_year_mod = map(data, nb_year_fun),
           nb_year_tidy = map(nb_year_mod, ~ broom::tidy(., conf.int = TRUE)))


#write_rds(amb_nb, "data/amb_nb.rds")
#write_rds(hosp_nb, "data/hosp_nb.rds")
#write_rds(rme_nb, "data/rme_nb.rds")

```



## Bootstrap negative binomial models

Issue: control for long-term time trends; including `year` as a dummy time variable pulls variane also associated with changes in temperature/heat.

Approach: bootstrap model, selecting iterations of 2-3 year intervals to control for time trend.  
Execute resampling of dataset and calculation of your statistics on these samples.


## Random year blocks

### 2-year block limits (min and max year)
```{r random_blocks}


amb_min_yr <- min(as.numeric(
                hsi_select %>% 
                  filter(type %in% "Ambulatory Data") %>% 
                  pull(year)))

amb_max_yr <- max(as.numeric(
                hsi_select %>% 
                  filter(type %in% "Ambulatory Data") %>% 
                  pull(year)))


# # Create randomized year dataframe (not currently used)
# # Random years for two year block
# amb_random_yrs_10k <- sample(amb_min_yr:(amb_max_yr - 1), size = 10000, replace = TRUE) 
# 
# # Dataframe of 10,000 random two year blocks
# amb_two_yr_blocks <-
#   amb_random_yrs_10k %>% 
#     tibble::enframe(name = NULL) %>% 
#     rename(first_yr = value) %>% 
#     mutate(second_yr = first_yr + 1) 
# 
# amb_two_yr_blocks

################################################################

hosp_min_yr <- min(as.numeric(
                hsi_select %>% 
                  filter(type %in% "Hospitalizations") %>% 
                  pull(year)))

hosp_max_yr <- max(as.numeric(
                hsi_select %>% 
                  filter(type %in% "Hospitalizations") %>% 
                  pull(year)))



######################################################################

rme_min_yr <- min(as.numeric(
                hsi_select %>% 
                  filter(type %in% "Reportable Events") %>% 
                  pull(year)))

rme_max_yr <- max(as.numeric(
                hsi_select %>% 
                  filter(type %in% "Reportable Events") %>% 
                  pull(year)))

# # For two year block
# 
# rme_random_yrs_10k <- sample(rme_min_yr:(rme_max_yr - 1), size = 10000, replace = TRUE) 
# 
# # Dataframe of 10,000 random two year blocks
# rme_two_yr_blocks <-
#   rme_random_yrs_10k %>% 
#     tibble::enframe(name = NULL) %>% 
#     rename(first_yr = value) %>% 
#     mutate(second_yr = first_yr + 1) 
# 
# rme_two_yr_blocks

```


### Bootstrap random two year blocks
Draw random blocks with replacement; stitch to original dataframe length

```{r amb_boot_2yr, eval = FALSE}

amb_index_2yr_fun <- function(outcome_data, i) {
  # Select random start year
  random_year <- replicate(10, sample(amb_min_yr:(amb_max_yr - 1), size = 1, replace = TRUE))
  random_years <- as.integer(c(random_year, random_year + 1))
  # select the observations to subset. 
  block_obs <- 
    random_years %>%
      map_dfr(~outcome_data %>% filter(year %in% .x))
  # run regression for given replicate, return estimated coefficients
  coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = block_obs))
}





# citation("MASS")

ptm <- proc.time()

amb_boot_2yr_block <-
  ambulatory_data %>% 
    nest(amb_data = installation:population) %>% 
  mutate(boot = map(amb_data, ~ boot(., amb_index_2yr_fun, 10000)),
         tidy = map(boot, ~ broom::tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")),
         tidy_bca = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "bca")))

proc.time() - ptm



write_rds(amb_boot_2yr_block, path = "data/amb_boot_2yr_block.rds")


```


```{r hosp_boot_2yr, eval = FALSE}

hosp_index_2yr_fun <- function(outcome_data, i) {
  # Select random start year
  random_year <- replicate(13, sample(hosp_min_yr:(hosp_max_yr - 1), size = 1, replace = TRUE))
  random_years <- as.integer(c(random_year, random_year + 1))
  
  # select the observations to subset. 
  block_obs <- 
    random_years %>%
      map_dfr(~outcome_data %>% filter(year %in% .x))
  # run regression for given replicate, return estimated coefficients
  coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = block_obs))
}


ptm <- proc.time()

hosp_boot_2yr_block <-
  hospitalization_data %>% 
    nest(hosp_data = installation:population) %>% 
  mutate(boot = map(hosp_data, ~ boot(., hosp_index_2yr_fun, 10000)),
         tidy = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")),
         tidy_bca = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "bca")))

proc.time() - ptm


write_rds(hosp_boot_2yr_block, path = "data/hosp_boot_2yr_block.rds")

```

```{r  rme_boot_2yr, eval = FALSE}

rme_index_2yr_fun <- function(outcome_data, i) {
  # Select random start year
  random_year <- replicate(11, sample(rme_min_yr:(rme_max_yr - 1), size = 1, replace = TRUE))
  random_years <- as.integer(c(random_year, random_year + 1))
  
  # select the observations to subset. 
  block_obs <- 
     random_years %>%
      map_dfr(~outcome_data %>% filter(year %in% .x))
  # run regression for given replicate, return estimated coefficients
  coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = block_obs))
}


ptm <- proc.time()

rme_boot_2yr_block <-
  rme_data %>% 
    nest(re_data = installation:population) %>% 
  mutate(boot = map(re_data, ~ boot(., rme_index_2yr_fun, 10000)),
         tidy = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))
        
proc.time() - ptm



rme_boot_2yr_block <-
  rme_boot_2yr_block %>% 
    mutate(tidy_bca = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "bca")))
  
#write_rds(rme_boot_2yr_block, path = "data/rme_boot_2yr_block.rds")

rme_boot_2yr_block %>% 
  pull(boot)

```



### All indices, 2-year block bootstrap

```{r}

ptm <- proc.time()

amb_boot_2yr_block_all <-
  ambulatory_data_full %>% 
    nest(amb_data = installation:population) %>% 
  mutate(boot = map(amb_data, ~ boot(., amb_index_2yr_fun, 2000)),
         tidy = map(boot, ~ broom::tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))

proc.time() - ptm

write_rds(amb_boot_2yr_block_all, path = "data/amb_boot_2yr_block_all.rds")



ptm <- proc.time()

hosp_boot_2yr_block_all <-
  hospitalization_data_full %>% 
    nest(hosp_data = installation:population) %>% 
  mutate(boot = map(hosp_data, ~ boot(., hosp_index_2yr_fun, 2000)),
         tidy = map(boot, ~ broom::tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))

proc.time() - ptm

write_rds(hosp_boot_2yr_block_all, path = "data/hosp_boot_2yr_block_all.rds")


ptm <- proc.time()

rme_boot_2yr_block_all <-
  rme_data_full %>% 
    nest(rme_data = installation:population) %>% 
  mutate(boot = map(rme_data, ~ boot(., amb_index_2yr_fun, 2000)),
         tidy = map(boot, ~ broom::tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))

proc.time() - ptm

# write_rds(rme_boot_2yr_block_all, path = "data/rme_boot_2yr_block_all.rds")


```


### Additional indices, 2-year block bootstrap

Did not initially include `absolute` day/hour count indices restricted to MAY-SEP.
Data preparation code is in `/heat_stress/addl_indices.Rmd`

```{r}

may_sep_day_hour_join <-
  read_rds("data/may_sep_day_hour_join.rds") %>% 
  filter(!index %in% c("days_hi_gt125_may_sep",
                        "hours_hi_gt125_may_sep"))   # Too many zero values, models will not run with NAs for t2* 



amb_boot_2yr_block_addl <-
  may_sep_day_hour_join %>%
    filter(type %in% "Ambulatory Data") %>% 
    dplyr::select(index, installation, year, count, value, population) %>% 
    nest(amb_data = installation:population) %>% 
    mutate(boot = map(amb_data, ~ boot(., amb_index_2yr_fun, 2000)),
           tidy = map(boot, ~ broom::tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))

write_rds(amb_boot_2yr_block_addl, path = "data/amb_boot_2yr_block_addl.rds")





hosp_boot_2yr_block_addl <-
   may_sep_day_hour_join %>%
    filter(type %in% "Hospitalizations") %>% 
    dplyr::select(index, installation, year, count, value, population) %>% 
    nest(hosp_data = installation:population) %>% 
  mutate(boot = map(hosp_data, ~ boot(., hosp_index_2yr_fun, 2000)),
         tidy = map(boot, ~ broom::tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))


write_rds(hosp_boot_2yr_block_addl, path = "data/hosp_boot_2yr_block_addl.rds")



rme_boot_2yr_block_addl <-
  may_sep_day_hour_join %>%
    filter(type %in% "Reportable Events") %>% 
    dplyr::select(index, installation, year, count, value, population) %>% 
    nest(rme_data = installation:population) %>% 
  mutate(boot = map(rme_data, ~ boot(., amb_index_2yr_fun, 2000)),
         tidy = map(boot, ~ broom::tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))


write_rds(rme_boot_2yr_block_addl, path = "data/rme_boot_2yr_block_addl.rds")


# amb_boot_2yr_block_addl <-
#   read_rds("data/amb_boot_2yr_block_addl.rds")
# 
# hosp_boot_2yr_block_addl <-
#   read_rds("data/hosp_boot_2yr_block_addl.rds")
# 
# rme_boot_2yr_block_addl <-
#   read_rds("data/rme_boot_2yr_block_addl.rds")


```








## Bootstrap 3 year blocks


```{r amb_boot_3yr}

# 20 year timeframe (1998-2018: stitch 6 replicates of 3 year blocks

amb_index_3yr_fun <- function(outcome_data, i) {
  # Select random start year
  random_year <- replicate(6, sample(amb_min_yr:(amb_max_yr - 2), size = 1, replace = TRUE))
  random_years <- as.integer(c(random_year, random_year + 1))
  # select the observations to subset. 
   block_obs <- 
      random_years %>%
        map_dfr(~outcome_data %>% filter(year %in% .x))
  # run regression for given replicate, return estimated coefficients
  coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = block_obs))
}


ptm <- proc.time()


amb_boot_3yr_block <-
  ambulatory_data %>% 
    nest(amb_data = installation:population) %>% 
    mutate(boot = map(amb_data, ~ boot(., amb_index_3yr_fun, 10000)),
           tidy = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))

proc.time() - ptm

write_rds(amb_boot_3yr_block, path = "data/amb_boot_3yr_block.rds")

```



```{r hosp_boot_3yr, eval = FALSE}

hosp_index_3yr_fun <- function(outcome_data, i) {
  # Select random start year
  random_year <- replicate(9, sample(hosp_min_yr:(hosp_max_yr - 2), size = 1, replace = TRUE))
  random_years <- as.integer(c(random_year, random_year + 1))
  # select the observations to subset. 
   block_obs <- 
        random_years %>%
          map_dfr(~outcome_data %>% filter(year %in% .x))
  # run regression for given replicate, return estimated coefficients
  coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = block_obs))
}


ptm <- proc.time()

hosp_boot_3yr_block <-
  hospitalization_data %>% 
    nest(hosp_data = installation:population) %>% 
    mutate(boot = map(hosp_data, ~ boot(., hosp_index_3yr_fun, 10000)))

proc.time() - ptm



hosp_boot_3yr_block <-
  hosp_boot_3yr_block %>% 
    mutate(tidy = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))


write_rds(hosp_boot_3yr_block, path = "data/hosp_boot_3yr_block.rds")


```

```{r  rme_boot_3yr, eval = FALSE}

rme_index_3yr_fun <- function(outcome_data, i) {
  # Select random start year
  random_year <- replicate(7, sample(rme_min_yr:(rme_max_yr - 2), size = 1, replace = TRUE))
  random_years <- as.integer(c(random_year, random_year + 1))
  # select the observations to subset. 
  block_obs <- 
      random_years %>%
        map_dfr(~outcome_data %>% filter(year %in% .x))
  # run regression for given replicate, return estimated coefficients
  coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = block_obs))
}


ptm <- proc.time()

rme_boot_3yr_block <-
  rme_data %>% 
    nest(re_data = installation:population) %>% 
    mutate(boot = map(re_data, ~ boot(., rme_index_3yr_fun, 10000)))

rme_boot_3yr_block <-
  rme_boot_3yr_block %>% 
    mutate(tidy = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))

proc.time() - ptm

write_rds(rme_boot_3yr_block, path = "data/rme_boot_3yr_block.rds")



```


## Bootstrap - original (draw single observations)

```{r boot_single, eval = FALSE}

std_boot <- function(D, d){
	E = D[d,]
	return(coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = E)))
	
}

amb_boot_std <-
  ambulatory_data %>%
    nest(amb_data = installation:population) %>% 
    mutate(std_boot = map(amb_data, ~ boot(., std_boot, R = 10000)),          
           tidy = map(std_boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))


hosp_boot_std <-
  hospitalization_data %>%
    nest(hosp_data = installation:population) %>% 
    mutate(hosp_boot = map(hosp_data, ~ boot(., std_boot, R = 10000)))

hosp_boot_std <-
  hosp_boot_std %>%            
    mutate(tidy = map(hosp_boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))


rme_boot_std <-
  rme_data %>%
    nest(re_data = installation:population) %>% 
    mutate(rme_boot = map(re_data, ~ boot(., std_boot, R = 10000)))

rme_boot_std <-
  rme_boot_std %>%            
    mutate(tidy = map(rme_boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))


#write_rds(amb_boot_std, path = "data/amb_boot_std.rds")
#write_rds(hosp_boot_std, path = "data/hosp_boot_std.rds")
#write_rds(rme_boot_std, path = "data/rme_boot_std.rds")

```






## RR whisker plot and table

```{r all_indices, eval = FALSE}




 rme_boot_2yr_block_all %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Event Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")
         


# ggsave("rme_all.png", width = 8, height = 10.5)




## Combined panel RR plot


amb_boot2_long <-
  amb_boot_2yr_block_all %>%
  bind_rows(amb_boot_2yr_block_addl) %>% 
    unnest(tidy) %>% 
    filter(term %in% "value") %>% 
    dplyr::select(index, statistic, bias, conf.low, conf.high) %>% 
    pivot_longer(cols = -index,
                 names_to = "term",
                 values_to = "value") %>% 
    mutate(outcome = "Ambulatory")
  
  
hosp_boot2_long <-
  hosp_boot_2yr_block_all %>%
     bind_rows(hosp_boot_2yr_block_addl) %>% 
    unnest(tidy) %>% 
    filter(term %in% "value") %>% 
    dplyr::select(index, statistic, bias, conf.low, conf.high) %>% 
    pivot_longer(cols = -index,
                 names_to = "term",
                 values_to = "value") %>% 
    mutate(outcome = "Hospitalizations")  


rme_boot2_long <-
  rme_boot_2yr_block_all %>%
    bind_rows(rme_boot_2yr_block_addl) %>% 
    unnest(tidy) %>% 
    filter(term %in% "value") %>% 
    dplyr::select(index, statistic, bias, conf.low, conf.high) %>% 
    pivot_longer(cols = -index,
                 names_to = "term",
                 values_to = "value") %>% 
    mutate(outcome = "Reportable Events")  


# Join dataframes

boot2_long <-
  amb_boot2_long %>% 
    bind_rows(hosp_boot2_long) %>% 
    bind_rows(rme_boot2_long)

# write_rds(boot2_long, path = "data/boot2_long.rds")

boot2_long <-
  read_rds(path = "data/boot2_long.rds")


## Full Index RR Plot - Facet
boot2_long %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")


#ggsave("output/boot2_all.png", width = 7.5, height = 22)
  
  
## Reduced Index RR Plot - Facet
 # remove focus indices, sd, minimum temperatures 
  
   

boot2_long %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  filter(!index %in% c("tmp_f_mean", "wbgt_f_mean", "heat_index_mean",
                       "tmp_f_mean_may_sep", "wbgt_f_mean_may_sep", "heat_index_mean_may_sep",
                       "tmp_f_sd", "wbgt_f_sd", "heat_index_sd",
                       "tmp_f_min", "heat_index_min", "wbgt_f_min")) %>% 
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")


#ggsave("boot2_reduced.png", width = 7.5, height = 9)





# Divide by degree units and days/hours

# Modify units: multiply hours by 24

# Degree indices
boot2_long %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  filter(!index %in% c("tmp_f_mean", "wbgt_f_mean", "heat_index_mean",
                       "tmp_f_mean_may_sep", "wbgt_f_mean_may_sep", "heat_index_mean_may_sep",
                       "tmp_f_sd", "wbgt_f_sd", "heat_index_sd",
                       "tmp_f_min", "heat_index_min", "wbgt_f_min"),
         !str_detect(index, "hour"),
         !str_detect(index, "day")) %>% 
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          #ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")

#ggsave("boot2_degrees.png", width = 8, height = 5)

# Days/hour indices


boot2_long %>%
  mutate(value = case_when(str_detect(index, "hour")  ~ value * 24,
                        TRUE ~ value)) %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  filter(!index %in% c("tmp_f_mean", "wbgt_f_mean", "heat_index_mean",
                       "tmp_f_mean_may_sep", "wbgt_f_mean_may_sep", "heat_index_mean_may_sep",
                       "tmp_f_sd", "wbgt_f_sd", "heat_index_sd",
                       "tmp_f_min", "heat_index_min", "wbgt_f_min"),
                        str_detect(index, "hour|day")) %>% 
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          #ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")


#ggsave("boot2_days.png", width = 8, height = 5)


# Slice top 20 ambulatory statistic

# vector of top 20 ambulatory indices
amb_top20_boot2_days <-
  boot2_long %>%
    mutate(value = case_when(str_detect(index, "hour")  ~ value * 24,
                          TRUE ~ value)) %>% 
    pivot_wider(names_from = term, 
                values_from = value) %>%
    filter(!index %in% c("tmp_f_mean", "wbgt_f_mean", "heat_index_mean",
                         "tmp_f_mean_may_sep", "wbgt_f_mean_may_sep", "heat_index_mean_may_sep",
                         "tmp_f_sd", "wbgt_f_sd", "heat_index_sd",
                         "tmp_f_min", "heat_index_min", "wbgt_f_min"),
                          str_detect(index, "hour|day"),
           outcome %in% "Ambulatory") %>% 
    dplyr::arrange(desc(statistic)) %>% 
    dplyr::slice(1:20) %>% 
    dplyr::select(index)


boot2_long %>%
  mutate(value = case_when(str_detect(index, "hour")  ~ value * 24,
                        TRUE ~ value)) %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  dplyr::semi_join(amb_top20_boot2_days, by = "index") %>% 
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          #ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")


#ggsave("boot2_days.png", width = 8, height = 5)





boot2_long %>% 
  mutate(value = case_when(str_detect(index, "hour")  ~ value * 24,
                        TRUE ~ value)) %>% 
  pivot_wider(names_from = term, 
              values_from = value) %>%
  filter(!index %in% c("tmp_f_mean", "wbgt_f_mean", "heat_index_mean",
                       "tmp_f_sd", "wbgt_f_sd", "heat_index_sd",
                       "tmp_f_min", "heat_index_min", "wbgt_f_min")) %>% 
  mutate(index = fct_reorder(index, exp(statistic))) %>% 
  ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         facet_wrap(~outcome) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
          ggtitle("HSI Rate Ratios from Annual Indices of Heat") +
         xlab("Rate Ratio")








# RR Table
amb_boot_2yr_block_all %>% 
  unnest(tidy) %>%
      filter(term %in% "value") %>% 
  dplyr::select(index, statistic, bias, conf.low, conf.high) %>% 
  mutate(rr = exp(statistic),
         rr_low = exp(conf.low),
         rr_high = exp(conf.high),
         rate_ratio = paste0(round(rr, 2), " (", round(rr_low, 2), ", ", round(rr_high, 2), ")")) %>% 
  dplyr::select(index, rate_ratio) %>% 
  as.data.frame() %>% print()


```


## Positive and Negative Association RR Tables

```{r}

# All index - outcome pairs

boot2_long %>% 
 mutate(association = paste(index, "-", outcome)) %>%
  pivot_wider(names_from = term, values_from = value) %>% 
  mutate(mean_boot_est = statistic - bias,
         rr = exp(mean_boot_est),
         rr_low = exp(conf.low),
         rr_high = exp(conf.high),
         rate_ratio = paste0(format(round(rr, digits = 2), nsmall = 2), " (", format(round(rr_low, digits = 2), nsmall = 2), ", ", format(round(rr_high, digits = 2), nsmall = 2), ")"))
  



# As single dataframe with column for association clasification
  # define whether RR is positive, negative, or null
  # classify by timeframe: full-year/heat season
  # classify by exposure measure: days/hours/degrees 
  # classify by index type: temp/HI/WBGT
  # classify as anomaly-based: anomaly/non-anomaly 

boot2_results <-
  boot2_long %>%
     mutate(association = paste(index, "-", outcome)) %>%
      pivot_wider(names_from = term, values_from = value) %>% 
      mutate(mean_boot_est = statistic - bias,
             rr = exp(mean_boot_est),
             rr_low = exp(conf.low),
             rr_high = exp(conf.high),
             rate_ratio = paste0(format(round(rr, digits = 2), nsmall = 2), " (", format(round(rr_low, digits = 2), nsmall = 2), ", ", format(round(rr_high, digits = 2), nsmall = 2), ")")) %>% 
    mutate(ci_range = case_when(
        rr_low > 1 ~ "positive",
        rr_high < 1 ~ "negative",
        TRUE ~ "null"
      ),
      exp_measure = case_when(
        str_detect(index, "day") ~ "Day",
        str_detect(index, "hour") ~ "Hour",
        TRUE ~ "Deg"
      ),
      
      anomaly = case_when(
        str_detect(index, "anom|pct|sd") ~ "Anomaly",
        TRUE ~ "Non-Anomaly"
      ),
      index_type = case_when(
        str_detect(index, "temp|tmp") ~ "T",
        str_detect(index, "heat_index|hi") ~ "HI",
        str_detect(index, "wbgt") ~ "WBGT",
        TRUE ~ "not classified"
      ),
      timeframe = case_when(
        str_detect(index, "may") ~ "May-Sep",
        TRUE ~ "Full Yr"
      )
             ) 


#write_rds(boot2_results, "data/boot2_results.rds")

boot2_results <-
  read_rds("data/boot2_results.rds")



# Overview Table

  boot2_results %>% 
    dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
    mutate_all(as_factor) %>% 
    table1::table1(~ outcome + index_type + timeframe + exp_measure + anomaly | ci_range, data = ., overall = "Total", row_wise = TRUE)

  
  boot2_results %>% 
    dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
    mutate_all(as_factor) %>% 
    table1::table1(~ ci_range | outcome + index_type , data = ., overall = "Total")
  



# Cross-tabulate associations

outcome_structable <-
  boot2_results %>% 
    dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
    vcd::structable(ci_range ~ outcome, .)

vcd::mosaic(outcome_structable, highlighting = "ci_range", highlighting_fill = c("red4", "tan", "darkgreen"))


boot2_results %>% 
  dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
  vcd::structable(outcome + timeframe ~ ci_range, .)

boot2_results %>% 
  dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
  vcd::structable(outcome + index_type ~ ci_range, .)

outcome_time_structable <-
  boot2_results %>% 
    dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
    vcd::structable(ci_range ~ outcome + timeframe, .)



#png("output/mosaic_time.png")

vcd::mosaic(outcome_time_structable, highlighting = "ci_range", highlighting_fill = c("red4", "tan", "darkgreen"))
#dev.off()


#png("output/mosaic_measure.png")

outcome_measure_structable <-
  boot2_results %>% 
    dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
    vcd::structable(ci_range ~ outcome + exp_measure, .)

vcd::mosaic(outcome_measure_structable, highlighting = "ci_range", highlighting_fill = c("red4", "tan", "darkgreen"))

#dev.off()




#png("output/mosaic_anomaly.png")

outcome_anomaly_structable <-
  boot2_results %>% 
    dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
    vcd::structable(ci_range ~ outcome + anomaly, .)

vcd::mosaic(outcome_anomaly_structable, highlighting = "ci_range", highlighting_fill = c("red4", "tan", "darkgreen"))
#dev.off()


#png("output/mosaic_index_type.png")

outcome_index_type_structable <-
  boot2_results %>% 
    dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
    vcd::structable(ci_range ~ outcome + index_type, .)

vcd::mosaic(outcome_index_type_structable, highlighting = "ci_range", highlighting_fill = c("red4", "tan", "darkgreen"))
#dev.off()



 boot2_results %>% 
    dplyr::select(outcome, exp_measure, anomaly, index_type, timeframe, ci_range) %>% 
    vcd::structable(ci_range ~ index_type, .) %>% 
    mosaic(., highlighting = "ci_range", highlighting_fill = c("red4", "tan", "darkgreen"))


# # Positive associations
# 
# 
# positive_2yr_boot <-
#   boot2_long %>% 
#    mutate(association = paste(index, "-", outcome)) %>%
#     pivot_wider(names_from = term, values_from = value) %>% 
#     mutate(mean_boot_est = statistic - bias,
#            rr = exp(mean_boot_est),
#            rr_low = exp(conf.low),
#            rr_high = exp(conf.high),
#            rate_ratio = paste0(format(round(rr, digits = 2), nsmall = 2), " (", format(round(rr_low, digits = 2), nsmall = 2), ", ", format(round(rr_high, digits = 2), nsmall = 2), ")")) %>% 
#     dplyr::filter(rr_low > 1)
#   
# 
# positive_2yr_boot %>% 
#   group_by(outcome) %>% 
#   count()
# 
# # Negative associations
# 
# negative_2yr_boot <-
#   boot2_long %>% 
#    mutate(association = paste(index, "-", outcome)) %>%
#     pivot_wider(names_from = term, values_from = value) %>% 
#     mutate(mean_boot_est = statistic - bias,
#            rr = exp(mean_boot_est),
#            rr_low = exp(conf.low),
#            rr_high = exp(conf.high),
#            rate_ratio = paste0(format(round(rr, digits = 2), nsmall = 2), " (", format(round(rr_low, digits = 2), nsmall = 2), ", ", format(round(rr_high, digits = 2), nsmall = 2), ")")) %>% 
#     dplyr::filter(rr_high < 1)
# 
# 
# negative_2yr_boot %>% 
#   group_by(outcome) %>% 
#   count()
# 
# 
# # No association
# 
# no_assoc_boot <-
#   boot2_long %>%
#    mutate(association = paste(index, "-", outcome)) %>%
#     pivot_wider(names_from = term, values_from = value) %>% 
#     mutate(mean_boot_est = statistic - bias,
#            rr = exp(mean_boot_est),
#            rr_low = exp(conf.low),
#            rr_high = exp(conf.high),
#            rate_ratio = paste0(format(round(rr, digits = 2), nsmall = 2), " (", format(round(rr_low, digits = 2), nsmall = 2), ", ", format(round(rr_high, digits = 2), nsmall = 2), ")")) %>% 
#     anti_join(positive_2yr_boot, by = "association") %>% 
#     anti_join(negative_2yr_boot, by = "association")





```




# Sensitivity analysis plots



```{r}

a1 <-
amb_boot_2yr_block %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n 2 year block (primary analysis, 10k)") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

a2 <-
amb_boot_2yr_block %>% 
    unnest(tidy_bca) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n 2 year block - Bca CIs, 10k") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

a3 <-
amb_boot_3yr_block %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n 3 year block, 10k") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))


a4 <-
amb_boot_std %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n standard bootstrap (single year, 10k)") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

a5 <-
amb_nb %>% 
    unnest(nb_tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(estimate))) %>% 
   ggplot() +
        geom_point(aes(x = exp(estimate), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n neg bin - no year term, no bootstrap") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

a6 <-
amb_nb %>% 
    unnest(nb_year_tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(estimate))) %>% 
   ggplot() +
        geom_point(aes(x = exp(estimate), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Ambulatory \n neg bin - with year term, no bootstrap") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))


#patchwork
(a1 + a2 + a3) / (a4 + a5 + a6)

ggsave("amb_sens.png", width = 10, height = 6)
```



```{r}

r1 <-
rme_boot_2yr_block %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n 2 year block (primary analysis, 10k)") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

r2 <-
rme_boot_2yr_block %>% 
    unnest(tidy_bca) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n 2 year block - Bca CIs, 10k") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

r3 <-
rme_boot_3yr_block %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n 3 year block, 10k") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))


r4 <-
rme_boot_std %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n standard bootstrap (single year, 10k)") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

r5 <-
rme_nb %>% 
    unnest(nb_tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(estimate))) %>% 
   ggplot() +
        geom_point(aes(x = exp(estimate), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n neg bin - no year term, no bootstrap") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))

r6 <-
rme_nb %>% 
    unnest(nb_year_tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(estimate))) %>% 
   ggplot() +
        geom_point(aes(x = exp(estimate), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events \n neg bin - with year term, no bootstrap") +
         xlab("Rate Ratio") +
         theme(plot.title = element_text(size = 8))


#patchwork
(r1 + r2 + r3) / (r4 + r5 + r6)

ggsave("rme_sens.png", width = 10, height = 6)
```






### Hospitalization, all indices, 100 bootstrap

```{r}
ptm <- proc.time()

hosp_boot_2yr_block_all <-
  hospitalization_data_full %>% 
    nest(hosp_data = installation:population) %>% 
  mutate(boot = map(hosp_data, ~ boot(., hosp_index_2yr_fun, 100)),
         tidy = map(boot, ~ broom::tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))

proc.time() - ptm

#write_rds(hosp_boot_2yr_block_all, path = "data/hosp_boot_2yr_block_all.rds")



hosp_boot_2yr_block_all %>% 
  unnest(tidy) %>%
      filter(term %in% "value") %>%
 ggplot() +
      geom_point(aes(x = exp(statistic), y = index)) +
      geom_point(aes(x = exp(statistic + bias), y = index), color = "red", shape = 4) +
      geom_errorbarh(
        aes(y = index,
            xmin = exp(conf.low),
            xmax = exp(conf.high))) +
       geom_vline(aes(xintercept = 1), colour = "blue") +
       theme_bw() +
       theme(axis.text.y = element_text(size = rel(0.75))) +
       ggtitle("Hospitalization Rate Ratio, Bootstrap, 2 year block, 100 iterations")


hosp_boot_2yr_block_all %>% 
  unnest(tidy) %>%
      filter(term %in% "value") %>% 
  dplyr::select(index, statistic, bias, conf.low, conf.high) %>% 
  mutate(rr = exp(statistic),
         rr_low = exp(conf.low),
         rr_high = exp(conf.high),
         rate_ratio = paste0(round(rr, 2), " (", round(rr_low, 2), ", ", round(rr_high, 2), ")")) %>% 
  dplyr::select(index, rate_ratio) %>% 
  as.data.frame() %>% print()
```



```{r}


ptm <- proc.time()

rme_boot_2yr_block_all <-
  rme_data_full %>% 
    nest(rme_data = installation:population) %>% 
  mutate(boot = map(rme_data, ~ boot(., rme_index_2yr_fun, 100)),
         tidy = map(boot, ~ broom::tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))

proc.time() - ptm

#write_rds(rme_boot_2yr_block_all, path = "data/rme_boot_2yr_block_all.rds")


rme_boot2_all_plot <-
  rme_boot_2yr_block_all %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_point(aes(x = exp(statistic + bias), y = index), color = "red", shape = 4) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75))) +
         ggtitle("Reportable Event Rate Ratio, Bootstrap, 2 year block, 100 iterations")

# Limit x axis (RR) to 2.5
  rme_boot_2yr_block_all %>% 
    unnest(tidy) %>%
        filter(term %in% "value") %>%
    mutate(index = fct_reorder(index, exp(statistic))) %>% 
   ggplot() +
        geom_point(aes(x = exp(statistic), y = index)) +
        geom_errorbarh(
          aes(y = index,
              xmin = exp(conf.low),
              xmax = exp(conf.high))) +
         geom_vline(aes(xintercept = 1), colour = "blue") +
         coord_cartesian(xlim = c(0.75, 2.0)) +
         theme_bw() +
         theme(axis.text.y = element_text(size = rel(0.75)),
               axis.title.y = element_blank()) +
         ggtitle("Reportable Events") +
         xlab("Rate Ratio")
         


#ggsave("rme_all.png", width = 8, height = 10.5)


rme_boot_2yr_block_all %>% 
  unnest(tidy) %>%
      filter(term %in% "value") %>% 
  dplyr::select(index, statistic, bias, conf.low, conf.high) %>% 
  mutate(rr = exp(statistic),
         rr_low = exp(conf.low),
         rr_high = exp(conf.high),
         rate_ratio = paste0(round(rr, 2), " (", round(rr_low, 2), ", ", round(rr_high, 2), ")")) %>% 
  dplyr::select(index, rate_ratio) %>% 
  as.data.frame() %>% print()
```



### Bootstrap 2 year block plots

```{r}
amb_boot_2yr_block %>% 
  unnest(tidy) %>%
      filter(term %in% "value") %>%
 ggplot() +
      geom_point(aes(x = exp(statistic), y = index)) +
      geom_point(aes(x = exp(statistic + bias), y = index), color = "red", shape = 4) +
      geom_errorbarh(
        aes(y = index,
            xmin = exp(conf.low),
            xmax = exp(conf.high))) +
       geom_vline(aes(xintercept = 1), colour = "blue") +
       theme_bw() +
       theme(axis.text.y = element_text(size = rel(0.75))) +
       ggtitle("Ambulatory Rate Ratio, Bootstrap, 2 year block, 10,000 iterations")


hosp_boot_2yr_block %>% 
  unnest(tidy) %>%
      filter(term %in% "value") %>%
 ggplot() +
      geom_point(aes(x = exp(statistic), y = index)) +
      geom_point(aes(x = exp(statistic + bias), y = index), color = "red", shape = 4) +
      geom_errorbarh(
        aes(y = index,
            xmin = exp(conf.low),
            xmax = exp(conf.high))) +
       geom_vline(aes(xintercept = 1), colour = "blue") +
       theme_bw() +
       theme(axis.text.y = element_text(size = rel(0.75))) +
       ggtitle("Hospitalization Rate Ratio, Bootstrap, 2 year block, 10,000 iterations")

rme_boot_2yr_block %>% 
  unnest(tidy) %>%
      filter(term %in% "value") %>%
 ggplot() +
      geom_point(aes(x = exp(statistic), y = index)) +
      geom_point(aes(x = exp(statistic + bias), y = index), color = "red", shape = 4) +
      geom_errorbarh(
        aes(y = index,
            xmin = exp(conf.low),
            xmax = exp(conf.high))) +
       geom_vline(aes(xintercept = 1), colour = "blue") +
       theme_bw() +
       theme(axis.text.y = element_text(size = rel(0.75))) +
       ggtitle("Reportable Event Rate Ratio, Bootstrap, 2 year block, 10,000 iterations")

```







## Bootstrap 3 year blocks


```{r amb_boot_3yr, eval = FALSE}

# 20 year timeframe (1998-2018: stitch 6 replicates of 3 year blocks

amb_index_3yr_fun <- function(x, i) {
  # Select random start year
  random_year <- replicate(6, sample(amb_min_yr:(amb_max_yr - 2), size = 1, replace = TRUE))
  # select the observations to subset. 
  block_obs <- 
    map_dfr(random_year, ~ x %>% 
      filter(year %in% c(random_year, random_year + 1, random_year + 2) ))
  # run regression for given replicate, return estimated coefficients
  coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = block_obs))
}


ptm <- proc.time()

plan(multiprocess)

amb_boot_3yr_block <-
  ambulatory_data %>% 
    nest(amb_data = installation:population) %>% 
  mutate(boot = future_map(amb_data, ~ boot(., amb_index_3yr_fun, 10000)),
         tidy = future_map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))

proc.time() - ptm

write_rds(amb_boot_3yr_block, path = "data/amb_boot_3yr_block.rds")

```



```{r hosp_boot_3yr, eval = FALSE}

hosp_index_3yr_fun <- function(x, i) {
  # Select random start year
  random_year <- replicate(9, sample(hosp_min_yr:(hosp_max_yr - 2), size = 1, replace = TRUE))
  # select the observations to subset. 
  block_obs <- 
    map_dfr(random_year, ~ x %>% 
      filter(year %in% c(random_year, random_year + 1, random_year + 2) ))
  # run regression for given replicate, return estimated coefficients
  coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = block_obs))
}


ptm <- proc.time()

hosp_boot_3yr_block <-
  hospitalization_data %>% 
    nest(hosp_data = installation:population) %>% 
  mutate(boot = future_map(hosp_data, ~ boot(., hosp_index_3yr_fun, 10000)))

proc.time() - ptm






write_rds(hosp_boot_3yr_block, path = "data/hosp_boot_3yr_block.rds")

hosp_boot_3yr_block <-
  hosp_boot_3yr_block %>% 
    mutate(tidy = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")),
           tidy_bca = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "bca")))

# BCa CI warnings (34):  In norm.inter(t, adj.alpha) : extreme order statistics used as endpoints

```

```{r  rme_boot_3yr, eval = FALSE}

rme_index_3yr_fun <- function(x, i) {
  # Select random start year
  random_year <- replicate(7, sample(rme_min_yr:(rme_max_yr - 2), size = 1, replace = TRUE))
  # select the observations to subset. 
  block_obs <- 
    map_dfr(random_year, ~ x %>% 
      filter(year %in% c(random_year, random_year + 1, random_year + 2) ))
  # run regression for given replicate, return estimated coefficients
  coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = block_obs))
}


ptm <- proc.time()

rme_boot_3yr_block <-
  rme_data %>% 
    nest(re_data = installation:population) %>% 
  mutate(boot = future_map(re_data, ~ boot(., rme_index_3yr_fun, 10000)))

rme_boot_3yr_block <-
  rme_boot_3yr_block %>% 
    mutate(tidy = map(boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))

proc.time() - ptm

write_rds(rme_boot_3yr_block, path = "data/rme_boot_3yr_block.rds")



```


## Bootstrap - original (draw single observations)

```{r boot_single, eval = FALSE}

std_boot <- function(D, d){
	E = D[d,]
	return(coefficients(MASS::glm.nb(count ~ value + installation + offset(log(population)), data = E)))
	
}

amb_boot_std <-
  ambulatory_data %>%
    nest(amb_data = installation:population) %>% 
    mutate(std_boot = map(amb_data, ~ boot(., std_boot, R = 10000)),          tidy = map(std_boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))


hosp_boot_std <-
  hospitalization_data %>%
    nest(hosp_data = installation:population) %>% 
    mutate(hosp_boot = map(hosp_data, ~ boot(., std_boot, R = 10000)))

hosp_boot_std <-
  hosp_boot_std %>%            
    mutate(tidy = map(hosp_boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))


rme_boot_std <-
  rme_data %>%
    nest(re_data = installation:population) %>% 
    mutate(rme_boot = map(re_data, ~ boot(., std_boot, R = 10000)))

rme_boot_std <-
  rme_boot_std %>%            
    mutate(tidy = map(rme_boot, ~ tidy(., conf.int = TRUE, conf.level = 0.95, conf.method = "basic")))


#write_rds(amb_boot_std, path = "data/amb_boot_std.rds")
#write_rds(hosp_boot_std, path = "data/hosp_boot_std.rds")
#write_rds(rme_boot_std, path = "data/rme_boot_std.rds")

```





